<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Biodata Siswa Kelas 7H â€” Kartu Pelajar (9:16)</title>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --card-w:360px;
    --card-h:640px; /* 9:16 portrait */
    --accent:#0d47a1;
    --bg:#e8f0fb;
  }
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    font-family: Arial, sans-serif;
  }

  .viewport{
    height:100vh;
    width:100vw;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .scale-wrapper{
    transform-origin: top left;
  }

  .card{
    width:var(--card-w);
    height:var(--card-h);
    background:#fff;
    border-radius:14px;
    box-shadow:0 8px 30px rgba(8,35,71,0.12);
    padding:14px;
    box-sizing:border-box;
    border-top:8px solid var(--accent);
    display:flex;
    flex-direction:column;
  }

  .header{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:center;
    flex-direction:column;
    text-align:center;
  }
  .header img.logo{ width:64px; height:auto; display:block; }
  .school-title{ color:var(--accent); font-weight:700; font-size:18px; margin:0; }
  .subtitle{ font-size:12px; margin:0; color:#333; }

  .photo-wrap{ display:flex; justify-content:center; margin:10px 0 6px 0; }
  .photo{ width:110px; height:140px; object-fit:cover; border-radius:6px; border:2px solid var(--accent); }

  .data-area{
    flex:1;
    overflow:hidden;
    padding:4px 2px 0 2px;
    box-sizing:border-box;
  }

  .rows{
    display:block;
    max-height:100%;
  }

  .row{
    display:flex;
    align-items:center;
    padding:6px 8px;
    font-size:12px;
    line-height:1;
    min-height:22px;
  }
  .row:nth-child(odd){ background:#f6f9ff; }
  .label{ width:140px; font-weight:700; font-size:12px; color:#111; }
  .colon{ width:10px; text-align:center; color:#111; }
  .value{ flex:1; font-size:12px; color:#222; word-break:break-word; }

  .controls{ display:flex; gap:8px; justify-content:center; margin-top:8px; }
  .btn{
    background:var(--accent);
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:8px;
    font-size:13px;
    cursor:pointer;
  }
  .download-menu{
    display:none;
    margin-top:8px;
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:center;
  }
  .download-menu .btn{ width:240px; padding:10px; }

  @media (max-width:420px){
    .label{ width:120px; font-size:11px; }
    .value{ font-size:11px; }
    .school-title{ font-size:16px; }
  }
</style>
</head>
<body>
  <div class="viewport">
    <div class="scale-wrapper">
      <div id="card" class="card">
        <div class="header">
          <img class="logo" id="logoImg" src="https://raw.githubusercontent.com/yanuar-moga/guruwali/main/assets/logo.png" alt="logo">
          <h1 class="school-title">SMP Negeri 1 Moga</h1>
          <div class="subtitle">Biodata Siswa Kelas 7H</div>
        </div>

        <div class="photo-wrap">
          <img id="foto" class="photo" src="" alt="Foto Siswa">
        </div>

        <div class="data-area">
          <div id="rows" class="rows"></div>
        </div>
      </div>
    </div>
  </div>

  <div style="position:fixed; left:50%; transform:translateX(-50%); bottom:14px; display:flex; flex-direction:column; align-items:center;">
    <div class="controls">
      <button class="btn" onclick="prev()">â—€ Prev</button>
      <button class="btn" onclick="next()">Next â–¶</button>
      <button class="btn" onclick="toggleMenu()">Download â–¼</button>
    </div>

    <div id="downloadMenu" class="download-menu" style="display:none;">
      <button class="btn" onclick="downloadJPG()">ðŸ“· Download JPG</button>
      <button class="btn" onclick="downloadPDFsingle()">ðŸ“„ Download PDF Kartu Ini</button>
      <button class="btn" onclick="downloadPDFall()">ðŸ“š Download PDF Semua Kartu</button>
    </div>
  </div>

<script>
/* Config */
const EXCEL_RAW_URL = "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/assets/data.xlsx";
const FOTO_BASES = [
  "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/foto/",
  "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/FOTO/",
  "https://raw.githubusercontent.com/yanuar-moga/guruwali/master/foto/",
  "https://raw.githubusercontent.com/yanuar-moga/guruwali/master/FOTO/"
];
const FOTO_EXTS = [".jpg", ".JPG", ".jpeg", ".png"];

/* Fields to show (in this exact order) */
const SHOW_FIELDS = [
  "NO","NAMA LENGKAP","NAMA PANGGIL","JENIS KELAMIN","Tempat Lahir","Tgl Lahir","Alamat","No WA Siswa",
  "Hobi","Cita-cita","NIS","NISN","Pelajaran yg disukai","Pelajaran tdk disukai","Ekskul","Kegiatan yg memotivasi di sekolah","Cara Belajar",
  "Harapan Orang Tua","Penerima KIP","ADA KARTU KIP","YATIM/PIATU","MONDOK"
];

let siswa = [];
let idx = 0;

/* Utilities */
function formatTanggalExcel(val){
  if (typeof val !== "number") return val;
  const jsDate = new Date((val - 25569) * 86400 * 1000);
  const bulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
  return `${jsDate.getDate()} ${bulan[jsDate.getMonth()]} ${jsDate.getFullYear()}`;
}

function autoScale(){
  const wrapper = document.querySelector('.scale-wrapper');
  const card = document.querySelector('.card');
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const scaleX = vw / card.offsetWidth;
  const scaleY = vh / card.offsetHeight;
  const scale = Math.min(scaleX, scaleY);
  wrapper.style.transform = `scale(${scale})`;
}

function setFotoByNo(no, imgEl){
  const num = (no === undefined || no === null || no === "") ? null : String(no).trim();
  const finalNo = (num && !isNaN(Number(num))) ? num : null;
  let baseIdx = 0, extIdx = 0;

  function tryNext(){
    if (baseIdx >= FOTO_BASES.length){
      imgEl.src = "https://via.placeholder.com/110x140?text=No+Photo";
      return;
    }
    const base = FOTO_BASES[baseIdx];
    const ext = FOTO_EXTS[extIdx];
    const file = (finalNo !== null) ? `${finalNo}${ext}` : `${(idx+1)}${ext}`;
    const url = base + file;

    const tester = new Image();
    tester.onload = function(){ imgEl.src = url; };
    tester.onerror = function(){ extIdx++; if (extIdx >= FOTO_EXTS.length){ baseIdx++; extIdx = 0; } tryNext(); };
    tester.src = url;
  }
  tryNext();
}

function escapeHtml(str){
  if (str === null || str === undefined) return "";
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* Load Excel */
async function loadExcel(){
  try{
    const res = await fetch(EXCEL_RAW_URL);
    if (!res.ok) throw new Error("Gagal fetch Excel: " + res.status);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    siswa = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    if (!Array.isArray(siswa)) siswa = [];
    idx = 0;
    render();
  }catch(err){
    console.error(err);
    alert("Gagal memuat data Excel. Periksa koneksi atau URL.");
  }
}

/* Render only SHOW_FIELDS in order */
function render(){
  autoScale();
  if (!siswa.length){
    document.getElementById('rows').innerHTML = "<div style='padding:16px; text-align:center;'>Tidak ada data siswa</div>";
    document.getElementById('foto').src = "https://via.placeholder.com/110x140?text=No+Photo";
    return;
  }
  const s = siswa[idx];

  // determine photo number from NO column, or fallback to idx+1
  const possibleNo = s.NO ?? s["NO"] ?? s["No"] ?? s["no"] ?? s["No."] ?? null;
  setFotoByNo(possibleNo, document.getElementById('foto'));

  const rowsContainer = document.getElementById('rows');
  rowsContainer.innerHTML = "";

  // iterate through SHOW_FIELDS, fetch value from student object case-insensitively
  SHOW_FIELDS.forEach((fieldKey) => {
    // find actual key in s that matches ignoring case & trimming spaces
    const foundKey = Object.keys(s).find(k => k.trim().toLowerCase() === fieldKey.trim().toLowerCase());
    let rawVal = foundKey ? s[foundKey] : "";
    let val = rawVal;

    const lowerKey = fieldKey.toLowerCase();
    if ((lowerKey.includes("tgl") || lowerKey.includes("tanggal") || lowerKey.includes("lahir")) && typeof rawVal === "number"){
      val = formatTanggalExcel(rawVal);
    } else {
      val = (rawVal === null || rawVal === undefined) ? "" : rawVal;
    }

    const rowEl = document.createElement('div');
    rowEl.className = 'row';
    rowEl.innerHTML = `<div class="label">${escapeHtml(fieldKey)}</div><div class="colon">:</div><div class="value">${escapeHtml(val)}</div>`;
    rowsContainer.appendChild(rowEl);
  });
}

/* Navigation */
function next(){ if (idx < siswa.length - 1) idx++; render(); }
function prev(){ if (idx > 0) idx--; render(); }

/* Downloads */
function toggleMenu(){ const m = document.getElementById('downloadMenu'); m.style.display = (m.style.display === 'none' || m.style.display==='') ? 'flex' : 'none'; }

function downloadJPG(){
  const card = document.getElementById('card');
  html2canvas(card, { scale: 3, useCORS: true }).then(canvas => {
    const a = document.createElement('a');
    const no = siswa[idx]?.NO ?? (idx+1);
    a.href = canvas.toDataURL('image/jpeg', 1.0);
    a.download = `Kartu-${no}.jpg`;
    a.click();
  });
}

function downloadPDFsingle(){
  const { jsPDF } = window.jspdf;
  const card = document.getElementById('card');
  html2canvas(card, { scale: 3, useCORS: true }).then(canvas => {
    const img = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jsPDF('p','px',[400,600]);
    const no = siswa[idx]?.NO ?? (idx+1);
    pdf.addImage(img, 'JPEG', 10, 10, 380, 580);
    pdf.save(`Kartu-${no}.pdf`);
  });
}

async function downloadPDFall(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','px',[400,600]);
  for (let i=0; i<siswa.length; i++){
    idx = i;
    render();
    await new Promise(r => setTimeout(r, 250));
    const canvas = await html2canvas(document.getElementById('card'), { scale: 3, useCORS: true });
    const img = canvas.toDataURL('image/jpeg',1.0);
    if (i>0) pdf.addPage();
    pdf.addImage(img, 'JPEG', 10, 10, 380, 580);
  }
  pdf.save('Semua-Kartu-Siswa.pdf');
}

/* Init */
window.addEventListener('load', () => {
  loadExcel();
  autoScale();
  window.addEventListener('resize', autoScale);
});
</script>
</body>
</html>
