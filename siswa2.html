<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Siswa - Biodata & Menu</title>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ============ layout ============ */
body { margin: 0; font-family: Arial, sans-serif; background: #eef3f9; }

/* two-column layout */
.layout { display: flex; min-height: 100vh; }

/* sidebar (left) */
.sidebar { width: 220px; background: #0d47a1; color: white; padding: 18px 12px; box-sizing: border-box; }
.sidebar h3 { margin: 6px 0 18px 8px; font-size: 16px; text-align: left; }
.sidebar .menu a { display: block; color: #fff; text-decoration: none; padding: 10px 12px; margin: 6px 0; border-radius: 6px; font-size: 14px; }
.sidebar .menu a:hover { background: rgba(255,255,255,0.08); }

/* main content */
.main { flex: 1; padding: 18px; box-sizing: border-box; position: relative; }
.topbar { display:flex; justify-content: flex-end; align-items: center; gap: 12px; margin-bottom: 8px; }
.topbar .sessionName { color: #0d47a1; font-weight: bold; }
.topbar button.logoutBtn { background: #d32f2f; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }

/* --- KARTU 9:16 --- */
.card { width: 360px; height: 640px; background: white; border-radius: 16px; padding: 18px; margin: 6px auto 20px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-top: 8px solid #0d47a1; display: flex; flex-direction: column; overflow: hidden; }
.header { text-align: center; }
.header img { width: 70px; }
.header h2 { font-size: 20px; margin: 5px 0 0 0; color: #0d47a1; }
.photo { width: 120px; height: 150px; object-fit: cover; border-radius: 10px; margin: 10px auto; display: block; border: 2px solid #0d47a1; }

/* data */
.data-box { flex: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
.row { display: flex; padding: 6px 8px; }
.row:nth-child(odd) { background: #f5f8ff; }
.label { width: 150px; font-weight: bold; font-size: 13px; }
.colon { width: 10px; }
.value { flex: 1; font-size: 13px; }

/* content area (right under card) */
#contentArea { max-width: 900px; margin: 12px auto; padding: 12px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

/* floating menu bottom */
.floating-menu { position: fixed; bottom: 0; left: 220px; width: calc(100% - 220px); background: #0d47a1; padding: 10px 0; text-align: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); }
.floating-menu button { padding: 10px 16px; background: white; color: #0d47a1; border: none; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: bold; }
#downloadMenu { background: white; padding: 10px; border-radius: 10px; margin-top: 5px; display: none; }
#downloadMenu button { width: 230px; background: #0d47a1; color: white; margin-bottom: 6px; }

/* responsive */
@media (max-width: 860px) {
  .layout { flex-direction: column; }
  .sidebar { width: 100%; display:flex; gap:12px; overflow:auto; }
  .floating-menu { left: 0; width: 100%; }
  .card { margin-top: 10px; }
}
</style>
</head>
<body>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h3>MENU</h3>
    <div class="menu">
      <a href="#" id="menu-biodata">üßæ Biodata</a>
      <a href="#" id="menu-curhat">üí¨ Curhat Siswa</a>
      <a href="#" id="menu-masalah">‚ö† Masalah Siswa</a>
      <a href="#" id="menu-notulen">üìù Notulen</a>
      <a href="#" id="menu-pembinaan">üë• Pembinaan</a>
      <a href="#" id="menu-pengumuman">üì¢ Pengumuman</a>
      <hr style="border-color: rgba(255,255,255,0.08); margin:12px 0;">
      <a href="#" id="menu-logout" style="background: rgba(255,255,255,0.06);">üîì Logout</a>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="sessionName" id="sessionName">Loading...</div>
      <button class="logoutBtn" id="logoutTop">Logout</button>
    </div>

    <!-- BIODATA CARD (paling atas) -->
    <div id="card" class="card">
        <div class="header">
            <img src="https://raw.githubusercontent.com/yanuar-moga/guruwali/main/assets/logo.png" alt="logo">
            <h2 id="judulCard">Biodata Siswa</h2>
        </div>

        <img id="foto" class="photo" src="" alt="Foto Siswa">

        <div id="data" class="data-box"></div>
    </div>

    <!-- content area (menu content shown here) -->
    <div id="contentArea">
      <!-- default: biodata info notice -->
      <p>Pilih menu di kiri untuk mengakses Curhat, Masalah, Notulen, Pembinaan, atau Pengumuman.</p>
    </div>

  </main>
</div>

<!-- FLOATING MENU -->
<div class="floating-menu" aria-hidden="false">
    <button onclick="prev()">‚óÄ Prev</button>
    <button onclick="next()">Next ‚ñ∂</button>
    <button onclick="toggleMenu()">Download ‚ñº</button>

    <div id="downloadMenu">
        <button onclick="downloadJPG()">üì∑ Download JPG</button>
        <button onclick="downloadPDFsingle()">üìÑ PDF Kartu Ini</button>
        <button onclick="downloadPDFall()">üìö PDF Semua Kartu</button>
    </div>
</div>

<script>
/* -------------------------
   Session & constants
   ------------------------- */
const SESSION_KEY = 'gw_ann_session_v3'; // must match your login script
const SESSION = (function(){ try { return JSON.parse(localStorage.getItem(SESSION_KEY)); } catch(e){ return null; } })();
if (!SESSION || SESSION.role !== 'siswa') { window.location.href = 'index.html'; }
document.getElementById('sessionName').textContent = SESSION.name + ' (' + SESSION.nisn + ')';

/* -------------------------
   Storage helpers
   ------------------------- */
function saveStudentData(nisn, obj) {
  localStorage.setItem('gw_data_' + nisn, JSON.stringify(obj));
}
function loadStudentData(nisn) {
  try { return JSON.parse(localStorage.getItem('gw_data_' + nisn)) || {}; } catch(e){ return {}; }
}
// global announcements (array)
function loadAnnouncements() {
  try { return JSON.parse(localStorage.getItem('gw_ann_announcements')) || []; } catch(e){ return []; }
}
function saveAnnouncements(arr) {
  localStorage.setItem('gw_ann_announcements', JSON.stringify(arr));
}

/* -------------------------
   Excel biodata loader
   ------------------------- */
let siswa = []; let index = 0;
function formatTanggal(excelDate) {
  if (!excelDate) return "-";
  if (isNaN(excelDate)) return excelDate;
  const date = new Date((excelDate - 25569) * 86400 * 1000);
  return date.toLocaleDateString("id-ID", { day: "2-digit", month: "long", year: "numeric" });
}

async function loadExcelAndFind() {
  const file = "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/assets/data.xlsx";
  try {
    const res = await fetch(file);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    siswa = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });

    const nisnStr = String(SESSION.nisn).trim();
    index = siswa.findIndex(s => String(s["NISN"]).trim() === nisnStr);
    if (index < 0) { index = 0; document.getElementById('contentArea').innerHTML = '<div style="background:#fff4e5;padding:10px;border-radius:8px;border:1px solid #ffd8a8;color:#8a5a00">Peringatan: NISN tidak ditemukan di Excel. Menampilkan data pertama.</div>'; }
    showData();
  } catch (err) {
    console.error('Gagal load Excel:', err);
    document.getElementById('contentArea').innerHTML = '<div style="color:red">Gagal memuat data Excel. Cek koneksi atau file data.xlsx.</div>';
  }
}

function showData() {
  if (!siswa || siswa.length === 0) return;
  const s = siswa[index] || {};
  const noFoto = index + 1;
  document.getElementById('foto').src = `https://raw.githubusercontent.com/yanuar-moga/guruwali/main/foto/${noFoto}.jpg`;
  const fields = [
    "NO","NAMA LENGKAP","NAMA PANGGIL","JENIS KELAMIN","Tempat Lahir",
    "Tgl Lahir","Alamat","No WA Siswa","Hobi","Cita-cita",
    "NIS","NISN","Pelajaran yg disukai","Pelajaran tdk disukai",
    "Ekskul","Kegiatan yg memotivasi di sekolah","Cara Belajar",
    "Harapan Orang Tua","Penerima KIP","ADA KARTU KIP",
    "YATIM/PIATU","MONDOK"
  ];
  let html = "";
  fields.forEach(k=>{
    let val = s[k] || "-";
    if (k === "Tgl Lahir") val = formatTanggal(val);
    html += `<div class="row"><div class="label">${k}</div><div class="colon">:</div><div class="value">${val}</div></div>`;
  });
  document.getElementById('data').innerHTML = html;
  document.getElementById('judulCard').textContent = 'Biodata - ' + (s['NAMA LENGKAP'] || SESSION.name || '-');
}

/* navigation for card */
function next(){ if (!siswa) return; if (index < siswa.length - 1) index++; showData(); }
function prev(){ if (!siswa) return; if (index > 0) index--; showData(); }
function toggleMenu(){ const m = document.getElementById('downloadMenu'); m.style.display = (m.style.display === 'none' || m.style.display === '') ? 'block' : 'none'; }

/* download helpers */
function downloadJPG(){ html2canvas(document.getElementById("card"), { scale: 3 }).then(canvas=>{ const a=document.createElement('a'); a.href=canvas.toDataURL('image/jpeg'); a.download=`Kartu-${index+1}.jpg`; a.click(); }); }
function downloadPDFsingle(){ const { jsPDF } = window.jspdf; html2canvas(document.getElementById("card"), { scale: 3 }).then(canvas=>{ const pdf=new jsPDF("p","px",[400,640]); pdf.addImage(canvas.toDataURL("image/jpeg"),"JPEG",10,10,380,620); pdf.save(`Kartu-${index+1}.pdf`); }); }
async function downloadPDFall(){ const { jsPDF } = window.jspdf; const pdf = new jsPDF("p","px",[400,640]); for (let i=0;i<siswa.length;i++){ index=i; showData(); await new Promise(r=>setTimeout(r,120)); await html2canvas(document.getElementById("card"),{scale:3}).then(canvas=>{ if(i>0) pdf.addPage(); pdf.addImage(canvas.toDataURL("image/jpeg"),"JPEG",10,10,380,620); }); } pdf.save("Semua-Kartu-Siswa.pdf"); }

/* -------------------------
   Menu: CURHAT
   - each student stores curhat array in gw_data_{NISN}.curhat = [...]
   ------------------------- */
function openCurhat() {
  const data = loadStudentData(SESSION.nisn);
  const curhats = data.curhat || [];
  let html = `<h3>Curhat Siswa</h3>
    <p>Isi curhat/keluh kesah Anda. Data tersimpan di browser dan hanya bisa dilihat guru jika mereka mengambil datanya.</p>
    <form id="frmCurhat">
      <div><label>Judul</label><br><input id="ch_judul" style="width:100%"></div>
      <div style="margin-top:8px;"><label>Isi</label><br><textarea id="ch_isi" rows="5" style="width:100%"></textarea></div>
      <div style="margin-top:8px;"><button type="button" id="btnSaveCurhat">Kirim Curhat</button></div>
    </form>
    <hr>
    <h4>Riwayat Curhat Anda (${curhats.length})</h4>
    <div id="curhatList">` ;
  if (curhats.length === 0) html += '<p>Belum ada curhat.</p>';
  curhats.slice().reverse().forEach((c,i)=>{
    html += `<div style="padding:8px;border:1px solid #eee;border-radius:8px;margin-bottom:8px;">
      <div style="font-weight:bold">${c.judul || '(Tanpa Judul)'}</div>
      <div style="font-size:12px;color:#666">${c.ts}</div>
      <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(c.isi)}</div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('contentArea').innerHTML = html;

  document.getElementById('btnSaveCurhat').addEventListener('click', ()=>{
    const judul = document.getElementById('ch_judul').value.trim();
    const isi = document.getElementById('ch_isi').value.trim();
    if (!isi) return alert('Isi curhat kosong.');
    const curhat = { judul, isi, ts: new Date().toLocaleString() };
    data.curhat = data.curhat || [];
    data.curhat.push(curhat);
    saveStudentData(SESSION.nisn, data);
    alert('Curhat tersimpan.');
    openCurhat();
  });
}

/* -------------------------
   Menu: MASALAH
   - students can report issue; stored in gw_data_{NISN}.issues (array)
   - each issue: {id, kategori, title, desc, status, ts}
   ------------------------- */
function openMasalah() {
  const data = loadStudentData(SESSION.nisn);
  const issues = data.issues || [];
  let html = `<h3>Laporkan Masalah</h3>
    <form id="frmIssue">
      <div><label>Kategori</label><br>
        <select id="iss_kat"><option>Pribadi</option><option>Akademik</option><option>Sosial</option><option>Lainnya</option></select></div>
      <div style="margin-top:8px;"><label>Judul</label><br><input id="iss_judul" style="width:100%"></div>
      <div style="margin-top:8px;"><label>Deskripsi</label><br><textarea id="iss_desc" rows="4" style="width:100%"></textarea></div>
      <div style="margin-top:8px;"><button type="button" id="btnSaveIssue">Kirim Laporan</button></div>
    </form>
    <hr>
    <h4>Riwayat Laporan (${issues.length})</h4>
    <div id="issueList">`;
  if (issues.length === 0) html += '<p>Belum ada laporan.</p>';
  issues.slice().reverse().forEach((it)=>{
    html += `<div style="padding:8px;border:1px solid #eee;border-radius:8px;margin-bottom:8px;">
      <div style="font-weight:bold">${it.title}</div>
      <div style="font-size:12px;color:#666">${it.ts} ‚Ä¢ ${it.kategori}</div>
      <div style="margin-top:6px">${escapeHtml(it.desc)}</div>
      <div style="margin-top:6px"><b>Status:</b> ${it.status || 'Baru'}</div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('contentArea').innerHTML = html;

  document.getElementById('btnSaveIssue').addEventListener('click', ()=>{
    const kategori = document.getElementById('iss_kat').value;
    const judul = document.getElementById('iss_judul').value.trim();
    const desc = document.getElementById('iss_desc').value.trim();
    if (!judul || !desc) return alert('Lengkapi judul dan deskripsi.');
    const item = { id: Date.now(), kategori, title: judul, desc, status: 'Baru', ts: new Date().toLocaleString() };
    data.issues = data.issues || [];
    data.issues.push(item);
    saveStudentData(SESSION.nisn, data);
    alert('Laporan terkirim.');
    openMasalah();
  });
}

/* -------------------------
   Menu: NOTULEN
   - students can add notes (notulen), stored per student
   ------------------------- */
function openNotulen(){
  const data = loadStudentData(SESSION.nisn);
  const notes = data.notulen || [];
  let html = `<h3>Notulen</h3>
    <p>Catatan singkat atau ringkasan kegiatan.</p>
    <form id="frmNotulen">
      <div><label>Judul</label><br><input id="nt_judul" style="width:100%"></div>
      <div style="margin-top:8px;"><label>Isi</label><br><textarea id="nt_isi" rows="5" style="width:100%"></textarea></div>
      <div style="margin-top:8px;"><button type="button" id="btnSaveNotulen">Simpan Notulen</button></div>
    </form><hr>
    <h4>Riwayat Notulen (${notes.length})</h4><div id="notulenList">`;
  if (notes.length === 0) html += '<p>Belum ada notulen.</p>';
  notes.slice().reverse().forEach(n=>{
    html += `<div style="padding:8px;border:1px solid #eee;border-radius:8px;margin-bottom:8px;">
      <div style="font-weight:bold">${n.judul || '(Tanpa Judul)'}</div>
      <div style="font-size:12px;color:#666">${n.ts}</div>
      <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(n.isi)}</div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('contentArea').innerHTML = html;

  document.getElementById('btnSaveNotulen').addEventListener('click', ()=>{
    const judul = document.getElementById('nt_judul').value.trim();
    const isi = document.getElementById('nt_isi').value.trim();
    if (!isi) return alert('Isi kosong.');
    const n = { judul, isi, ts: new Date().toLocaleString() };
    data.notulen = data.notulen || [];
    data.notulen.push(n);
    saveStudentData(SESSION.nisn, data);
    alert('Notulen tersimpan.');
    openNotulen();
  });
}

/* -------------------------
   Menu: PEMBINAAN
   - simple list + ability request pembinaan
   ------------------------- */
function openPembinaan(){
  const data = loadStudentData(SESSION.nisn);
  const pemb = data.pembinaan || [];
  let html = `<h3>Pembinaan</h3>
    <p>Daftar pembinaan / permintaan pembinaan.</p>
    <form id="frmPembinaan">
      <div><label>Topik</label><br><input id="pb_topik" style="width:100%"></div>
      <div style="margin-top:8px;"><label>Alasan / Catatan</label><br><textarea id="pb_cat" rows="3" style="width:100%"></textarea></div>
      <div style="margin-top:8px;"><button type="button" id="btnSavePembinaan">Minta Pembinaan</button></div>
    </form><hr>
    <h4>Riwayat Pembinaan (${pemb.length})</h4><div id="pembList">`;
  if (pemb.length === 0) html += '<p>Belum ada permintaan.</p>';
  pemb.slice().reverse().forEach(p=>{
    html += `<div style="padding:8px;border:1px solid #eee;border-radius:8px;margin-bottom:8px;">
      <div style="font-weight:bold">${p.topik || '(Tanpa Judul)'}</div>
      <div style="font-size:12px;color:#666">${p.ts}</div>
      <div style="margin-top:6px">${escapeHtml(p.note)}</div>
      <div style="margin-top:6px"><b>Status:</b> ${p.status || 'Menunggu'}</div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('contentArea').innerHTML = html;

  document.getElementById('btnSavePembinaan').addEventListener('click', ()=>{
    const topik = document.getElementById('pb_topik').value.trim();
    const note = document.getElementById('pb_cat').value.trim();
    if (!topik) return alert('Masukkan topik.');
    const item = { id: Date.now(), topik, note, status: 'Menunggu', ts: new Date().toLocaleString() };
    data.pembinaan = data.pembinaan || [];
    data.pembinaan.push(item);
    saveStudentData(SESSION.nisn, data);
    alert('Permintaan pembinaan terkirim.');
    openPembinaan();
  });
}

/* -------------------------
   Menu: PENGUMUMAN
   - read global announcements (gw_ann_announcements)
   - if student: can mark read
   ------------------------- */
function openPengumuman(){
  const anns = loadAnnouncements();
  // mark read state per student stored in gw_data_{NISN}.readAnnouncements = [ids]
  const data = loadStudentData(SESSION.nisn);
  const read = data.readAnnouncements || [];
  let html = `<h3>Pengumuman Sekolah</h3><p>Pengumuman resmi dari sekolah/guru.</p><div id="announceList">`;
  if (anns.length === 0) html += '<p>Belum ada pengumuman.</p>';
  anns.slice().reverse().forEach(a=>{
    const isRead = read.includes(a.id);
    html += `<div style="padding:8px;border:1px solid #eee;border-radius:8px;margin-bottom:8px;background:${isRead?'#f5fff5':'#fff'}">
      <div style="font-weight:bold">${a.title}</div>
      <div style="font-size:12px;color:#666">${a.ts}</div>
      <div style="margin-top:6px">${escapeHtml(a.text)}</div>
      <div style="margin-top:6px"><button data-id="${a.id}" class="btnMarkRead">${isRead?'Sudah dibaca':'Tandai Dibaca'}</button></div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('contentArea').innerHTML = html;

  document.querySelectorAll('.btnMarkRead').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = Number(e.target.dataset.id);
      data.readAnnouncements = data.readAnnouncements || [];
      if (!data.readAnnouncements.includes(id)) data.readAnnouncements.push(id);
      saveStudentData(SESSION.nisn, data);
      openPengumuman();
    });
  });
}

/* -------------------------
   Utilities
   ------------------------- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

/* -------------------------
   Menu wiring
   ------------------------- */
document.getElementById('menu-biodata').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('contentArea').innerHTML = '<p>Data biodata tampil di atas. Gunakan Prev/Next untuk pindah kartu.</p>'; });
document.getElementById('menu-curhat').addEventListener('click', (e)=>{ e.preventDefault(); openCurhat(); });
document.getElementById('menu-masalah').addEventListener('click', (e)=>{ e.preventDefault(); openMasalah(); });
document.getElementById('menu-notulen').addEventListener('click', (e)=>{ e.preventDefault(); openNotulen(); });
document.getElementById('menu-pembinaan').addEventListener('click', (e)=>{ e.preventDefault(); openPembinaan(); });
document.getElementById('menu-pengumuman').addEventListener('click', (e)=>{ e.preventDefault(); openPengumuman(); });
document.getElementById('menu-logout').addEventListener('click', (e)=>{ e.preventDefault(); logoutNow(); });
document.getElementById('logoutTop').addEventListener('click', logoutNow);

/* -------------------------
   Logout
   ------------------------- */
function logoutNow(){ localStorage.removeItem(SESSION_KEY); window.location.href = 'index.html'; }

/* -------------------------
   Bootstrap: load excel & then render default biodata + load student's saved data if any
   ------------------------- */
loadExcelAndFind();

/* expose helpers to console for teacher debugging */
window.__gw_helpers = { loadStudentData, saveStudentData, loadAnnouncements, saveAnnouncements, SESSION };
</script>

</body>
</html>
