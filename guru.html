<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Guru</title>
<link rel="stylesheet" href="style.css" />

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f6f9;
  }
  .layout {
    display: grid;
    grid-template-columns: 240px 1fr;
    min-height: 100vh;
  }
  .sidebar {
    background: #0A4FA3;
    color: #fff;
    padding: 20px;
  }
  .sidebar h3 {
    margin-top: 0;
  }
  .sidebar a {
    color: #fff;
    text-decoration: none;
    display: block;
    padding: 8px 0;
    cursor: pointer;
  }
  .content {
    padding: 22px;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 6px 18px rgba(10,79,163,0.06);
    margin-bottom: 20px;
  }

  .grafik-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 18px;
  }

  canvas {
    width: 100% !important;
    height: 300px !important;
  }
</style>

</head>
<body>
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h3>Menu Wali Kelas</h3>
    <a href="pengumuman.html">Pengumuman</a>
    <a href="curhatsiswa.html">Curhat Siswa</a>
    <a href="notulen.html">Notulen</a>
    <a href="#">Data Absensi</a>
    <a href="#">Laporan Perkembangan</a>

    <h3 style="margin-top:28px;">Menu Guru Wali</h3>
    <a onclick="loadProfilSiswa()">Profil Siswa</a>

    <a href="#">Rekap Nilai</a>
    <a href="#">Pelanggaran / Poin</a>
    <a href="#">Jadwal Konsultasi</a>

    <button onclick="logout()" style="margin-top:30px;background:#ff5d5d;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;width:100%;">Logout</button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="content" id="mainContent">

    <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
      <img src="assets/logo.png" style="width:48px;height:48px;object-fit:contain;" />
      <div>
        <h2 style="margin:0;color:#0A4FA3">Dashboard Guru</h2>
        <div style="color:#6c7a89;">Selamat datang, Bayu</div>
      </div>
    </div>

    <!-- 3 GRAFIK PIE -->
    <div class="grafik-row">
      <div class="card">
        <h3>Grafik Jenis Kelamin</h3>
        <canvas id="chartJK"></canvas>
      </div>

      <div class="card">
        <h3>Grafik Usia Siswa</h3>
        <canvas id="chartUsia"></canvas>
      </div>

      <div class="card">
        <h3>Grafik Penerima KIP</h3>
        <canvas id="chartKIP"></canvas>
      </div>
    </div>

  </div>
</div>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
function logout(){
  localStorage.removeItem('gw_ann_session_v3');
  window.location.href='index.html';
}

// ==============================
//  PALET WARNA
// ==============================
const colors = [
  "#36A2EB","#FF6384","#FFCE56","#4BC0C0",
  "#9966FF","#FF9F40","#66FF66","#FF6666",
  "#6699FF","#CC66FF","#FFCC99","#99CC00"
];


// ==============================
//  LOAD FILE EXCEL
// ==============================
async function loadExcel() {
  const url = "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/assets/data.xlsx";

  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf, { type: "array" });

  const sheet = wb.Sheets["DATA"];
  const rows = XLSX.utils.sheet_to_json(sheet);

  // ðŸ”¥ COUNTER
  let jkCount = { "Laki-laki": 0, "Perempuan": 0 };
  let usiaCount = {};
  let kipCount = { "Penerima KIP": 0, "Tidak": 0 };

  rows.forEach(r => {

    // =============================
    // 1. JENIS KELAMIN
    // =============================
    let jk = (r["JK"] || r["Jenis Kelamin"] || "").toString().trim();

    if (/^l/i.test(jk)) jkCount["Laki-laki"]++;
    else if (/^p/i.test(jk)) jkCount["Perempuan"]++;

    // =============================
    // 2. USIA (dari tanggal lahir)
    // =============================
    let tgl = r["TglLahir"] || r["Tanggal Lahir"];

    if (tgl) {
      let usia = hitungUsia(tgl);
      usiaCount[usia] = (usiaCount[usia] || 0) + 1;
    }

    // =============================
    // 3. PENERIMA KIP (kolom O)
    // =============================
    let kip = (r["KIP"] || r["Penerima KIP"] || r["Keterangan KIP"] || "").toString().trim();

    if (/ya|ada|menerima/i.test(kip)) kipCount["Penerima KIP"]++;
    else kipCount["Tidak"]++;
  });

  renderCharts(jkCount, usiaCount, kipCount);
}


// ==============================
//  Hitung Usia (otomatis dari kolom F)
// ==============================
function hitungUsia(tgl) {
  let date = new Date(tgl);
  if (isNaN(date)) return "Tidak diketahui";

  let now = new Date();
  let usia = now.getFullYear() - date.getFullYear();

  let m = now.getMonth() - date.getMonth();
  if (m < 0 || (m === 0 && now.getDate() < date.getDate())) usia--;

  return usia + " Tahun";
}


// ==============================
//  RENDER PIE CHART
// ==============================
function renderCharts(jkCount, usiaCount, kipCount) {

  // ---------------- JENIS KELAMIN ----------------
  new Chart(document.getElementById("chartJK"), {
    type: "pie",
    data: {
      labels: ["Laki-laki", "Perempuan"],
      datasets: [{
        data: [
          jkCount["Laki-laki"],
          jkCount["Perempuan"]
        ],
        backgroundColor: ["#36A2EB", "#FF6384"]
      }]
    }
  });

  // ---------------- USIA ----------------
  new Chart(document.getElementById("chartUsia"), {
    type: "pie",
    data: {
      labels: Object.keys(usiaCount),
      datasets: [{
        data: Object.values(usiaCount),
        backgroundColor: colors
      }]
    }
  });

  // ---------------- KIP ----------------
  new Chart(document.getElementById("chartKIP"), {
    type: "pie",
    data: {
      labels: ["Penerima KIP", "Tidak"],
      datasets: [{
        data: [
          kipCount["Penerima KIP"],
          kipCount["Tidak"]
        ],
        backgroundColor: ["#4BC0C0", "#FFCE56"]
      }]
    }
  });
}

loadExcel();
</script>
<!-- =====================================================
      LOAD PROFIL SISWA TANPA MERUSAK DESAIN (SPA MODE)
===================================================== -->
<script>
async function loadProfilSiswa() {
  const content = document.getElementById("mainContent");
  content.innerHTML = "<div class='card'>Memuat Profil Siswa...</div>";

  const url = "https://yanuar-moga.github.io/guruwali/biodata.html";

  try {
    const res = await fetch(url);
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    // Ambil isi <body> dari file biodata.html
    const bodyHTML = doc.body.innerHTML;

    // Ganti isi halaman utama
    content.innerHTML = bodyHTML;

    // Jalankan semua <script> dari biodata.html
    const scripts = doc.querySelectorAll("script");
    scripts.forEach(oldScript => {
      const newScript = document.createElement("script");
      if (oldScript.src) {
        newScript.src = oldScript.src;
      } else {
        newScript.textContent = oldScript.textContent;
      }
      document.body.appendChild(newScript);
    });

  } catch (err) {
    content.innerHTML = "<div class='card' style='color:red;'>Gagal memuat data siswa.</div>";
  }
}
</script>

</body>
</html>
