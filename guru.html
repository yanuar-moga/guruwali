<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Guru</title>
<link rel="stylesheet" href="style.css" />

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f6f9;
  }
  .layout {
    display: grid;
    grid-template-columns: 240px 1fr;
    min-height: 100vh;
  }
  .sidebar {
    background: #0A4FA3;
    color: #fff;
    padding: 20px;
  }
  .sidebar a {
    color: #fff;
    text-decoration: none;
    display: block;
    padding: 8px 0;
    cursor: pointer;
  }
  .content {
    padding: 22px;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 6px 18px rgba(10,79,163,0.06);
    margin-bottom: 20px;
  }
  .grafik-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 18px;
  }
  canvas {
    width: 100% !important;
    height: 300px !important;
  }
</style>

</head>
<body>
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h3>Menu Wali Kelas</h3>
    <a href="pengumuman.html">Pengumuman</a>
    <a href="curhatsiswa.html">Curhat Siswa</a>
    <a href="notulen.html">Notulen</a>
    <a href="#">Data Absensi</a>
    <a href="#">Laporan Perkembangan</a>

    <h3 style="margin-top:28px;">Menu Guru Wali</h3>

    <a onclick="loadProfilSiswa()">Profil Siswa</a>

    <a href="#">Rekap Nilai</a>
    <a href="#">Pelanggaran / Poin</a>
    <a href="#">Jadwal Konsultasi</a>

    <button onclick="logout()" style="margin-top:30px;background:#ff5d5d;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;width:100%;">Logout</button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="content" id="mainContent">

    <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
      <img src="assets/logo.png" style="width:48px;height:48px;object-fit:contain;" />
      <div>
        <h2 style="margin:0;color:#0A4FA3">Dashboard Guru</h2>
        <div style="color:#6c7a89;">Selamat datang, Bayu</div>
      </div>
    </div>

    <!-- GRAFIK ROW -->
    <div class="grafik-row">
      <div class="card">
        <h3>Grafik Jenis Kelamin</h3>
        <canvas id="chartJK"></canvas>
      </div>

      <div class="card">
        <h3>Grafik Usia Siswa</h3>
        <canvas id="chartUsia"></canvas>
      </div>

      <div class="card">
        <h3>Grafik Penerima KIP</h3>
        <canvas id="chartKIP"></canvas>
      </div>
    </div>

  </div>
</div>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
function logout(){
  localStorage.removeItem('gw_ann_session_v3');
  window.location.href='index.html';
}

const colors = [
  "#FF6384","#36A2EB","#FFCE56","#4BC0C0",
  "#9966FF","#FF9F40","#66FF66","#FF6666",
  "#6699FF","#CC66FF","#FFCC99","#99CC00"
];

async function loadExcel() {
  const url = "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/assets/data.xlsx";

  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf, { type: "array" });

  const sheet = wb.Sheets["DATA"];
  const rows = XLSX.utils.sheet_to_json(sheet);

  let jkCount = { "Laki-laki": 0, "Perempuan": 0 };
  let usiaCount = {};
  let kipCount = { "Penerima KIP": 0, "Tidak Menerima": 0 };

  const currentYear = new Date().getFullYear();

  rows.forEach(r => {

    // ===== JENIS KELAMIN =====
    let jk = (r["JK"] || r["Jenis Kelamin"] || "").toString().trim();
    if (/^l/i.test(jk)) jkCount["Laki-laki"]++;
    if (/^p/i.test(jk)) jkCount["Perempuan"]++;

    // ===== USIA SISWA =====
    let tglLahir = r["Tgl Lahir"] || r["TGL_LAHIR"] || r["F"];
    if (tglLahir) {
      let thn = new Date(tglLahir).getFullYear();
      let usia = currentYear - thn;
      usiaCount[usia] = (usiaCount[usia] || 0) + 1;
    }

    // ===== KIP (kolom AA) =====
    let kip = r["AA"] || r["KIP"] || "";
    kip = kip.toString().trim().toLowerCase();

    if (kip === "ya" || kip === "1") kipCount["Penerima KIP"]++;
    else kipCount["Tidak Menerima"]++;
  });

  renderCharts(jkCount, usiaCount, kipCount);
}


function renderCharts(jkCount, usiaCount, kipCount) {

  // JENIS KELAMIN
  new Chart(document.getElementById("chartJK"), {
    type: "pie",
    data: {
      labels: ["Laki-laki", "Perempuan"],
      datasets: [{
        data: [jkCount["Laki-laki"], jkCount["Perempuan"]],
        backgroundColor: ["#36A2EB", "#FF6384"]
      }]
    }
  });

  // USIA
  new Chart(document.getElementById("chartUsia"), {
    type: "pie",
    data: {
      labels: Object.keys(usiaCount),
      datasets: [{
        data: Object.values(usiaCount),
        backgroundColor: colors
      }]
    }
  });

  // PENERIMA KIP
  new Chart(document.getElementById("chartKIP"), {
    type: "pie",
    data: {
      labels: ["Penerima KIP", "Tidak Menerima"],
      datasets: [{
        data: [kipCount["Penerima KIP"], kipCount["Tidak Menerima"]],
        backgroundColor: ["#4BC0C0", "#FFCE56"]
      }]
    }
  });
}

loadExcel();


// =========================================================
//   LOAD PROFIL SISWA TANPA MERUSAK TAMPILAN DASHBOARD
//   + MENGHAPUS GRAFIK/JS DARI biodata.html
// =========================================================
async function loadProfilSiswa() {

  const content = document.getElementById("mainContent");
  content.innerHTML = "<div class='card'>Memuat Profil Siswa...</div>";

  const res = await fetch("https://yanuar-moga.github.io/guruwali/biodata.html");
  const html = await res.text();

  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");

  // HAPUS script, canvas, chart, menu duplikat
  doc.querySelectorAll("script").forEach(e => e.remove());
  doc.querySelectorAll("canvas").forEach(e => e.remove());
  doc.querySelectorAll("#chartJK, #chartHobi, #chartCita").forEach(e => e.remove());
  doc.querySelectorAll(".grafik-row").forEach(e => e.remove());

  content.innerHTML = doc.body.innerHTML;
}

</script>

</body>
</html>
