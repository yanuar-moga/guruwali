<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Biodata Siswa</title>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f3f3f3;
}
.container {
    max-width: 430px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
img.foto {
    width: 120px;
    height: 160px;
    object-fit: cover;
    border: 2px solid #333;
    margin-bottom: 15px;
}
.label {
    display: inline-block;
    width: 160px;
    font-weight: bold;
}
.p-val {
    display: inline-block;
    max-width: 220px;
    vertical-align: top;
}
p {
    margin: 4px 0;
    font-size: 14px;
}

/* tombol next prev */
.nav-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
}
.nav-buttons button {
    padding: 8px 15px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
.nav-buttons button:hover {
    background: #005fcc;
}

/* floating download button */
#downloadMenuBtn {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: #007bff;
    color: white;
    padding: 14px 20px;
    border-radius: 30px;
    font-size: 17px;
    cursor: pointer;
    border: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.25);
}

/* menu dropdown */
#menuPanel {
    position: fixed;
    right: 20px;
    bottom: 80px;
    background: white;
    border-radius: 10px;
    padding: 10px;
    width: 220px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    display: none;
}
#menuPanel div {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #ddd;
    font-size: 14px;
}
#menuPanel div:hover {
    background: #f0f0f0;
}
#menuPanel div:last-child {
    border-bottom: none;
}

/* small helper */
.top-controls {
    max-width: 430px;
    margin: 0 auto 10px auto;
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
}
.top-controls input[type="file"] { display: inline-block; }
.count-info { font-size: 13px; color:#333; }
</style>
</head>
<body>

<div class="top-controls">
    <div>
        <input type="file" id="fileInput" accept=".xlsx,.xls">
    </div>
    <div class="count-info" id="countInfo">Data: 0</div>
</div>

<div class="container" id="card">
    <h2 style="text-align:center;margin-top:0;">Biodata Siswa</h2>

    <div style="text-align:center;">
        <img id="foto" class="foto" src="" alt="Foto siswa">
    </div>

    <div id="data"></div>

    <div class="nav-buttons">
        <button onclick="prevCard()">Prev</button>
        <button onclick="nextCard()">Next</button>
    </div>
</div>

<!-- tombol floating -->
<button id="downloadMenuBtn" onclick="toggleMenu()">Download</button>

<!-- menu dropdown -->
<div id="menuPanel">
    <div onclick="downloadImage()">ðŸ“· Download Gambar</div>
    <div onclick="downloadPDFsingle()">ðŸ“„ Download PDF Kartu Ini</div>
    <div onclick="downloadPDFall()">ðŸ“š Download Semua PDF</div>
</div>

<script>
// CONFIG: sesuaikan jika ingin pakai branch lain
const GITHUB_RAW_BASES = [
    "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/foto/",
    "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/FOTO/",
    "https://raw.githubusercontent.com/yanuar-moga/guruwali/master/foto/",
    "https://raw.githubusercontent.com/yanuar-moga/guruwali/master/FOTO/"
];

let siswaData = [];
let index = 0;

// Konversi tanggal Excel (jika ada tanggal numeric)
function excelDateToText(value) {
    if (typeof value === "number") {
        const date = new Date((value - 25569) * 86400 * 1000);
        return date.toLocaleDateString("id-ID", {
            day: "numeric",
            month: "long",
            year: "numeric"
        });
    }
    return value === undefined || value === null ? "" : String(value);
}

// Daftar kolom sesuai yang kamu kirim (pakai key persis dari Excel)
const COLUMNS = [
    "NO","NAMA LENGKAP","NAMA PANGGIL","JENIS KELAMIN","Tempat Lahir","Tgl Lahir",
    "Alamat","No WA Siswa","No Wa Ortu","Hobi","Cita-cita","NIS","NISN",
    "Pelajaran yg disukai","Pelajaran tdk disukai","Ekskul","Kegiatan yg memotivasi di sekolah",
    "Cara Belajar","Nama Ayah","Pekerjaan Ayah","Pendidikan Ayah",
    "Nama Ibu","Pekerjaan Ibu","Pendidikan Ibu",
    "Yang sering dibicarakan dengan orang tua","Harapan Orang Tua",
    "Penerima KIP","ADA KARTU KIP","YATIM/PIATU","MONDOK"
];

// Tombol upload file Excel
document.getElementById('fileInput').addEventListener('change', function(evt){
    const f = evt.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = function(e){
        try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            siswaData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            if (!Array.isArray(siswaData)) siswaData = [];
            index = 0;
            document.getElementById('countInfo').textContent = `Data: ${siswaData.length}`;
            if (siswaData.length) showCard(0);
            else {
                document.getElementById('data').innerHTML = "<p>Tidak ada data.</p>";
                document.getElementById('foto').src = "";
            }
        } catch(err) {
            alert("Gagal membaca file Excel. Pastikan file valid .xlsx atau .xls");
            console.error(err);
        }
    };
    reader.readAsBinaryString(f);
});

// Mencoba beberapa path & ekstensi untuk foto
function tryLoadFotoByIndex(idx, imgEl) {
    const nomor = idx + 1; // urutan baris -> nomor file
    const exts = [".jpg", ".JPG", ".jpeg", ".png"];
    let tried = 0;

    function tryNextBase(baseIndex, extIndex) {
        if (baseIndex >= GITHUB_RAW_BASES.length) {
            // tidak ditemukan: tampilkan placeholder
            imgEl.src = "https://via.placeholder.com/120x160?text=No+Photo";
            return;
        }
        const url = GITHUB_RAW_BASES[baseIndex] + nomor + exts[extIndex];
        const tester = new Image();
        tester.onload = () => {
            imgEl.src = url;
        };
        tester.onerror = () => {
            // naikkan extIndex, jika habis naik baseIndex
            extIndex++;
            if (extIndex >= exts.length) {
                baseIndex++;
                extIndex = 0;
            }
            tryNextBase(baseIndex, extIndex);
        };
        tester.src = url;
    }

    tryNextBase(0, 0);
}

// Tampilkan 1 kartu (menggunakan urutan index untuk foto)
function showCard(i) {
    index = i;
    const s = siswaData[i];
    if (!s) {
        document.getElementById('data').innerHTML = "<p>Tidak ada data siswa pada index ini.</p>";
        document.getElementById('foto').src = "";
        return;
    }

    // Tampilkan foto berdasarkan urutan baris (index+1)
    tryLoadFotoByIndex(i, document.getElementById('foto'));

    // Bangun HTML biodata lengkap (tetap pakai tampilan semula)
    let html = "";
    // tampilkan kolom yang ada di COLUMNS (jika kosong tetap tampil label)
    COLUMNS.forEach(key => {
        const val = excelDateToText(s[key]);
        html += `<p><span class="label">${key}</span>: <span class="p-val">${val}</span></p>`;
    });

    // Jika ada kolom lain yang tidak ada di COLUMNS, tetap tampil (opsional)
    // (tampilkan sisa kolom)
    Object.keys(s).forEach(k => {
        if (!COLUMNS.includes(k)) {
            html += `<p><span class="label">${k}</span>: <span class="p-val">${excelDateToText(s[k])}</span></p>`;
        }
    });

    document.getElementById('data').innerHTML = html;
}

function nextCard() {
    if (index < siswaData.length - 1) showCard(index + 1);
}
function prevCard() {
    if (index > 0) showCard(index - 1);
}

// DOWNLOAD MENU
function toggleMenu() {
    const menu = document.getElementById("menuPanel");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function downloadImage() {
    html2canvas(document.getElementById("card")).then(canvas => {
        const link = document.createElement("a");
        link.download = `kartu_${index+1}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });
}

function downloadPDFsingle() {
    html2canvas(document.getElementById("card")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        // fit image to page width
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, "PNG", 10, 10, pdfWidth, pdfHeight);
        pdf.save(`kartu_${index+1}.pdf`);
    });
}

async function downloadPDFall() {
    const pdf = new jspdf.jsPDF();
    for (let i = 0; i < siswaData.length; i++) {
        showCard(i);
        // tunggu render
        // sedikit delay agar html2canvas mengambil gambar terbaru
        // (bisa disesuaikan jika perlu)
        await new Promise(res => setTimeout(res, 250));
        // capture
        // eslint-disable-next-line no-await-in-loop
        const canvas = await html2canvas(document.getElementById("card"));
        const img = canvas.toDataURL("image/png");
        if (i !== 0) pdf.addPage();
        const imgProps = pdf.getImageProperties(img);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(img, "PNG", 10, 10, pdfWidth, pdfHeight);
    }
    pdf.save("semua_kartu.pdf");
}

// helper: fallback foto jika file absent (sudah di tryLoadFotoByIndex)
// akhirnya: siap pakai

</script>

</body>
</html>
