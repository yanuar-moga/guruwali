<script>
// URL Excel
const url = "https://raw.githubusercontent.com/yanuar-moga/guruwali/main/assets/data.xlsx";

let siswaData = [];
let index = 0;

// Konversi tanggal Excel
function excelDateToText(value) {
    if (typeof value === "number") {
        const date = new Date((value - 25569) * 86400 * 1000);
        return date.toLocaleDateString("id-ID", {
            day: "numeric",
            month: "long",
            year: "numeric"
        });
    }
    return value;
}

// Label rapi
const LABEL_MAP = {
    "NAMA": "Nama",
    "NISN": "NISN",
    "NIS": "NIS",
    "KELAS": "Kelas",
    "TEMPAT_LAHIR": "Tempat Lahir",
    "TANGGAL_LAHIR": "Tanggal Lahir",
    "ALAMAT": "Alamat",
    "ABSEN": "Absen"
};

// Load Excel
fetch(url)
    .then(r => r.arrayBuffer())
    .then(buf => {
        const wb = XLSX.read(buf, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        siswaData = XLSX.utils.sheet_to_json(sheet);
        showCard(0);
    });

// Tampilkan 1 kartu
function showCard(i) {
    index = i;
    const s = siswaData[i];
    if (!s) return;

    // FOTO BERDASARKAN URUTAN BARIS (1, 2, 3, dst)
    const fotoNomor = i + 1;
    document.getElementById("foto").src =
        `https://raw.githubusercontent.com/yanuar-moga/guruwali/main/foto/${fotoNomor}.jpg`;

    // DATA RAPI
    let html = "";
    for (let key in s) {
        if (!LABEL_MAP[key]) continue;
        let label = LABEL_MAP[key];
        let value = excelDateToText(s[key]);

        html += `
            <p>
                <span class="label">${label}</span>: ${value}
            </p>
        `;
    }

    document.getElementById("data").innerHTML = html;
}

function nextCard() {
    if (index < siswaData.length - 1) showCard(index + 1);
}

function prevCard() {
    if (index > 0) showCard(index - 1);
}

/* Download menu */
function toggleMenu() {
    const menu = document.getElementById("menuPanel");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

/* Download gambar */
function downloadImage() {
    html2canvas(document.getElementById("card")).then(canvas => {
        const link = document.createElement("a");
        link.download = "kartu.png";
        link.href = canvas.toDataURL();
        link.click();
    });
}

/* Download PDF single */
function downloadPDFsingle() {
    html2canvas(document.getElementById("card")).then(canvas => {
        const img = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(img, "PNG", 10, 10, 190, 0);
        pdf.save("kartu.pdf");
    });
}

/* Download semua PDF */
async function downloadPDFall() {
    const pdf = new jspdf.jsPDF();

    for (let i = 0; i < siswaData.length; i++) {
        showCard(i);
        await html2canvas(document.getElementById("card")).then(canvas => {
            const img = canvas.toDataURL("image/png");
            if (i !== 0) pdf.addPage();
            pdf.addImage(img, "PNG", 10, 10, 190, 0);
        });
    }

    pdf.save("semua_kartu.pdf");
}
</script>
